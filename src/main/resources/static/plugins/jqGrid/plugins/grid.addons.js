(function(a){a.jgrid.extend({searchGrid:function(b){b=a.extend({recreateFilter:false,drag:true,sField:"searchField",sValue:"searchString",sOper:"searchOper",sFilter:"filters",loadDefaults:true,beforeShowSearch:null,afterShowSearch:null,onInitializeSearch:null,closeAfterSearch:false,closeAfterReset:false,closeOnEscape:false,multipleSearch:false,cloneSearchRowOnAdd:true,sopt:null,stringResult:undefined,onClose:null,useDataProxy:false,overlay:true},a.jgrid.search,b||{});return this.each(function(){var l=this;if(!l.grid){return}var f="fbox_"+l.p.id,g=true;function u(x,w){var k=x.p.postData[w.sFilter];if(typeof(k)=="string"){k=a.jgrid.parse(k)}if(k){if(k.groupOp){x.SearchFilter.setGroupOp(k.groupOp)}if(k.rules){var y,j=0,e=k.rules.length,z=false;for(;j<e;j++){y=k.rules[j];if(y.field!==undefined&&y.op!==undefined&&y.data!==undefined){z=x.SearchFilter.setFilter({sfref:x.SearchFilter.$.find(".sf:last"),filter:a.extend({},y)});if(z){x.SearchFilter.add()}}}}}}function c(e){if(b.onClose){var j=b.onClose(e);if(typeof j=="boolean"&&!j){return}}e.hide();if(b.overlay===true){a(".jqgrid-overlay:first","#gbox_"+l.p.id).hide()}}function d(){var k=a(".ui-searchFilter").length;if(k>1){var j=a("#"+f).css("zIndex");a("#"+f).css({zIndex:parseInt(j,10)+k})}a("#"+f).show();if(b.overlay===true){a(".jqgrid-overlay:first","#gbox_"+l.p.id).show()}try{a(":input:visible","#"+f)[0].focus()}catch(e){}}function s(w){var e=(w!==undefined),k=a("#"+l.p.id),j={};if(b.multipleSearch===false){j[b.sField]=w.rules[0].field;j[b.sValue]=w.rules[0].data;j[b.sOper]=w.rules[0].op;if(j.hasOwnProperty(b.sFilter)){delete j[b.sFilter]}}else{j[b.sFilter]=w;a.each([b.sField,b.sValue,b.sOper],function(x,y){if(j.hasOwnProperty(y)){delete j[y]}})}k[0].p.search=e;a.extend(k[0].p.postData,j);k.trigger("reloadGrid",[{page:1}]);if(b.closeAfterSearch){c(a("#"+f))}}function m(w){var k=w&&w.hasOwnProperty("reload")?w.reload:true,j=a("#"+l.p.id),e={};j[0].p.search=false;if(b.multipleSearch===false){e[b.sField]=e[b.sValue]=e[b.sOper]=""}else{e[b.sFilter]=""}a.extend(j[0].p.postData,e);if(k){j.trigger("reloadGrid",[{page:1}])}if(b.closeAfterReset){c(a("#"+f))}}if(a.fn.searchFilter){if(b.recreateFilter===true){a("#"+f).remove()}if(a("#"+f).html()!=null){if(a.isFunction(b.beforeShowSearch)){g=b.beforeShowSearch(a("#"+f));if(typeof(g)=="undefined"){g=true}}if(g===false){return}d();if(a.isFunction(b.afterShowSearch)){b.afterShowSearch(a("#"+f))}}else{var n=[],v=a("#"+l.p.id).jqGrid("getGridParam","colNames"),r=a("#"+l.p.id).jqGrid("getGridParam","colModel"),t=["eq","ne","lt","le","gt","ge","bw","bn","in","ni","ew","en","cn","nc"],i,q,h,p=[];if(b.sopt!==null){h=0;for(i=0;i<b.sopt.length;i++){if((q=a.inArray(b.sopt[i],t))!=-1){p[h]={op:b.sopt[i],text:b.odata[q].text};h++}}}else{for(i=0;i<t.length;i++){p[i]={op:t[i],text:b.odata[i].text}}}a.each(r,function(x,C){var z=(typeof C.search==="undefined")?true:C.search,y=(C.hidden===true),k=a.extend({},{text:v[x],itemval:C.index||C.name},this.searchoptions),w=(k.searchhidden===true);if(typeof k.sopt!=="undefined"){h=0;k.ops=[];if(k.sopt.length>0){for(i=0;i<k.sopt.length;i++){if((q=a.inArray(k.sopt[i],t))!=-1){k.ops[h]={op:k.sopt[i],text:b.odata[q].text};h++}}}}if(typeof(this.stype)==="undefined"){this.stype="text"}if(this.stype=="select"){if(k.dataUrl!==undefined){}else{var j;if(k.value){j=k.value}else{if(this.editoptions){j=this.editoptions.value}}if(j){k.dataValues=[];if(typeof(j)==="string"){var e=j.split(";"),B;for(i=0;i<e.length;i++){B=e[i].split(":");k.dataValues[i]={value:B[0],text:B[1]}}}else{if(typeof(j)==="object"){i=0;for(var A in j){if(j.hasOwnProperty(A)){k.dataValues[i]={value:A,text:j[A]};i++}}}}}}}if((w&&z)||(z&&!y)){n.push(k)}});if(n.length>0){a("<div id='"+f+"' role='dialog' tabindex='-1'></div>").insertBefore("#gview_"+l.p.id);if(b.stringResult===undefined){b.stringResult=b.multipleSearch}l.SearchFilter=a("#"+f).searchFilter(n,{groupOps:b.groupOps,operators:p,onClose:c,resetText:b.Reset,searchText:b.Find,windowTitle:b.caption,rulesText:b.rulesText,matchText:b.matchText,onSearch:s,onReset:m,stringResult:b.stringResult,ajaxSelectOptions:a.extend({},a.jgrid.ajaxOptions,l.p.ajaxSelectOptions||{}),clone:b.cloneSearchRowOnAdd});a(".ui-widget-overlay","#"+f).remove();if(l.p.direction=="rtl"){a(".ui-closer","#"+f).css("float","left")}if(b.drag===true){a("#"+f+" table thead tr:first td:first").css("cursor","move");if(jQuery.fn.jqDrag){a("#"+f).jqDrag(a("#"+f+" table thead tr:first td:first"))}else{try{a("#"+f).draggable({handle:a("#"+f+" table thead tr:first td:first")})}catch(o){}}}if(b.multipleSearch===false){a(".ui-del, .ui-add, .ui-del, .ui-add-last, .matchText, .rulesText","#"+f).hide();a("select[name='groupOp']","#"+f).hide()}if(b.multipleSearch===true&&b.loadDefaults===true){u(l,b)}if(a.isFunction(b.onInitializeSearch)){b.onInitializeSearch(a("#"+f))}if(a.isFunction(b.beforeShowSearch)){g=b.beforeShowSearch(a("#"+f));if(typeof(g)=="undefined"){g=true}}if(g===false){return}d();if(a.isFunction(b.afterShowSearch)){b.afterShowSearch(a("#"+f))}if(b.closeOnEscape===true){a("#"+f).keydown(function(j){if(j.which==27){c(a("#"+f))}if(j.which==13){a(".ui-search",this).click()}})}}}}})},updateGridRows:function(e,c,d){var b,g=false,f;this.each(function(){var i=this,k,l,j,h;if(!i.grid){return false}if(!c){c="id"}if(e&&e.length>0){a(e).each(function(n){j=this;l=i.rows.namedItem(j[c]);if(l){h=j[c];if(d===true){if(i.p.jsonReader.repeatitems===true){if(i.p.jsonReader.cell){j=j[i.p.jsonReader.cell]}for(var m=0;m<j.length;m++){k=i.formatter(h,j[m],m,j,"edit");f=i.p.colModel[m].title?{title:a.jgrid.stripHtml(k)}:{};if(i.p.treeGrid===true&&b==i.p.ExpandColumn){a("td:eq("+m+") > span:first",l).html(k).attr(f)}else{a("td:eq("+m+")",l).html(k).attr(f)}}g=true;return true}}a(i.p.colModel).each(function(o){b=d===true?this.jsonmap||this.name:this.name;if(j[b]!==undefined){k=i.formatter(h,j[b],o,j,"edit");f=this.title?{title:a.jgrid.stripHtml(k)}:{};if(i.p.treeGrid===true&&b==i.p.ExpandColumn){a("td:eq("+o+") > span:first",l).html(k).attr(f)}else{a("td:eq("+o+")",l).html(k).attr(f)}g=true}})}})}});return g},filterGrid:function(c,b){b=a.extend({gridModel:false,gridNames:false,gridToolbar:false,filterModel:[],formtype:"horizontal",autosearch:true,formclass:"filterform",tableclass:"filtertable",buttonclass:"filterbutton",searchButton:"Search",clearButton:"Clear",enableSearch:false,enableClear:false,beforeSearch:null,afterSearch:null,beforeClear:null,afterClear:null,url:"",marksearched:true},b||{});return this.each(function(){var l=this;this.p=b;if(this.p.filterModel.length===0&&this.p.gridModel===false){alert("No filter is set");return}if(!c){alert("No target grid is set!");return}this.p.gridid=c.indexOf("#")!=-1?c:"#"+c;var d=a(this.p.gridid).jqGrid("getGridParam","colModel");if(d){if(this.p.gridModel===true){var e=a(this.p.gridid)[0];var g;a.each(d,function(o,p){var m=[];this.search=this.search===false?false:true;if(this.editrules&&this.editrules.searchhidden===true){g=true}else{if(this.hidden===true){g=false}else{g=true}}if(this.search===true&&g===true){if(l.p.gridNames===true){m.label=e.p.colNames[o]}else{m.label=""}m.name=this.name;m.index=this.index||this.name;m.stype=this.edittype||"text";if(m.stype!="select"){m.stype="text"}m.defval=this.defval||"";m.surl=this.surl||"";m.sopt=this.editoptions||{};m.width=this.width;l.p.filterModel.push(m)}})}else{a.each(l.p.filterModel,function(o,p){for(var m=0;m<d.length;m++){if(this.name==d[m].name){this.index=d[m].index||this.name;break}}if(!this.index){this.index=this.name}})}}else{alert("Could not get grid colModel");return}var h=function(){var q={},p=0,n;var o=a(l.p.gridid)[0],m;o.p.searchdata={};if(a.isFunction(l.p.beforeSearch)){l.p.beforeSearch()}a.each(l.p.filterModel,function(u,w){m=this.index;if(this.stype==="select"){n=a("select[name="+m+"]",l).val();if(n){q[m]=n;if(l.p.marksearched){a("#jqgh_"+this.name,o.grid.hDiv).addClass("dirty-cell")}p++}else{if(l.p.marksearched){a("#jqgh_"+this.name,o.grid.hDiv).removeClass("dirty-cell")}try{delete o.p.postData[this.index]}catch(v){}}}else{n=a("input[name="+m+"]",l).val();if(n){q[m]=n;if(l.p.marksearched){a("#jqgh_"+this.name,o.grid.hDiv).addClass("dirty-cell")}p++}else{if(l.p.marksearched){a("#jqgh_"+this.name,o.grid.hDiv).removeClass("dirty-cell")}try{delete o.p.postData[this.index]}catch(t){}}}});var r=p>0?true:false;a.extend(o.p.postData,q);var s;if(l.p.url){s=a(o).jqGrid("getGridParam","url");a(o).jqGrid("setGridParam",{url:l.p.url})}a(o).jqGrid("setGridParam",{search:r}).trigger("reloadGrid",[{page:1}]);if(s){a(o).jqGrid("setGridParam",{url:s})}if(a.isFunction(l.p.afterSearch)){l.p.afterSearch()}};var k=function(){var q={},n,p=0;var o=a(l.p.gridid)[0],m;if(a.isFunction(l.p.beforeClear)){l.p.beforeClear()}a.each(l.p.filterModel,function(u,x){m=this.index;n=(this.defval)?this.defval:"";if(!this.stype){this.stype="text"}switch(this.stype){case"select":var w;a("select[name="+m+"] option",l).each(function(y){if(y===0){this.selected=true}if(a(this).text()==n){this.selected=true;w=a(this).val();return false}});if(w){q[m]=w;if(l.p.marksearched){a("#jqgh_"+this.name,o.grid.hDiv).addClass("dirty-cell")}p++}else{if(l.p.marksearched){a("#jqgh_"+this.name,o.grid.hDiv).removeClass("dirty-cell")}try{delete o.p.postData[this.index]}catch(v){}}break;case"text":a("input[name="+m+"]",l).val(n);if(n){q[m]=n;if(l.p.marksearched){a("#jqgh_"+this.name,o.grid.hDiv).addClass("dirty-cell")}p++}else{if(l.p.marksearched){a("#jqgh_"+this.name,o.grid.hDiv).removeClass("dirty-cell")}try{delete o.p.postData[this.index]}catch(t){}}break}});var r=p>0?true:false;a.extend(o.p.postData,q);var s;if(l.p.url){s=a(o).jqGrid("getGridParam","url");a(o).jqGrid("setGridParam",{url:l.p.url})}a(o).jqGrid("setGridParam",{search:r}).trigger("reloadGrid",[{page:1}]);if(s){a(o).jqGrid("setGridParam",{url:s})}if(a.isFunction(l.p.afterClear)){l.p.afterClear()}};var f;var j=function(){var p=document.createElement("tr");var n,r,m,o,q;if(l.p.formtype=="horizontal"){a(f).append(p)}a.each(l.p.filterModel,function(z,u){o=document.createElement("td");a(o).append("<label for='"+this.name+"'>"+this.label+"</label>");q=document.createElement("td");var y=this;if(!this.stype){this.stype="text"}switch(this.stype){case"select":if(this.surl){a(q).load(this.surl,function(){if(y.defval){a("select",this).val(y.defval)}a("select",this).attr({name:y.index||y.name,id:"sg_"+y.name});if(y.sopt){a("select",this).attr(y.sopt)}if(l.p.gridToolbar===true&&y.width){a("select",this).width(y.width)}if(l.p.autosearch===true){a("select",this).change(function(D){h();return false})}})}else{if(y.sopt.value){var s=y.sopt.value;var v=document.createElement("select");a(v).attr({name:y.index||y.name,id:"sg_"+y.name}).attr(y.sopt);var t,C,w;if(typeof s==="string"){t=s.split(";");for(var x=0;x<t.length;x++){C=t[x].split(":");w=document.createElement("option");w.value=C[0];w.innerHTML=C[1];if(C[1]==y.defval){w.selected="selected"}v.appendChild(w)}}else{if(typeof s==="object"){for(var B in s){if(s.hasOwnProperty(B)){z++;w=document.createElement("option");w.value=B;w.innerHTML=s[B];if(s[B]==y.defval){w.selected="selected"}v.appendChild(w)}}}}if(l.p.gridToolbar===true&&y.width){a(v).width(y.width)}a(q).append(v);if(l.p.autosearch===true){a(v).change(function(D){h();return false})}}}break;case"text":var A=this.defval?this.defval:"";a(q).append("<input type='text' name='"+(this.index||this.name)+"' id='sg_"+this.name+"' value='"+A+"'/>");if(y.sopt){a("input",q).attr(y.sopt)}if(l.p.gridToolbar===true&&y.width){if(a.browser.msie){a("input",q).width(y.width-4)}else{a("input",q).width(y.width-2)}}if(l.p.autosearch===true){a("input",q).keypress(function(E){var D=E.charCode?E.charCode:E.keyCode?E.keyCode:0;if(D==13){h();return false}return this})}break}if(l.p.formtype=="horizontal"){if(l.p.gridToolbar===true&&l.p.gridNames===false){a(p).append(q)}else{a(p).append(o).append(q)}a(p).append(q)}else{n=document.createElement("tr");a(n).append(o).append(q);a(f).append(n)}});q=document.createElement("td");if(l.p.enableSearch===true){r="<input type='button' id='sButton' class='"+l.p.buttonclass+"' value='"+l.p.searchButton+"'/>";a(q).append(r);a("input#sButton",q).click(function(){h();return false})}if(l.p.enableClear===true){m="<input type='button' id='cButton' class='"+l.p.buttonclass+"' value='"+l.p.clearButton+"'/>";a(q).append(m);a("input#cButton",q).click(function(){k();return false})}if(l.p.enableClear===true||l.p.enableSearch===true){if(l.p.formtype=="horizontal"){a(p).append(q)}else{n=document.createElement("tr");a(n).append("<td>&#160;</td>").append(q);a(f).append(n)}}};var i=a("<form name='SearchForm' style=display:inline;' class='"+this.p.formclass+"'></form>");f=a("<table class='"+this.p.tableclass+"' cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>");a(i).append(f);j();a(this).append(i);this.triggerSearch=h;this.clearSearch=k})}})})(jQuery);